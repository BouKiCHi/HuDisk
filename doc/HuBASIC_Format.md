# HuBASIC Format詳細

## 参考文献: 
http://www.z88dk.org/tools/x1/  
http://www.z88dk.org/tools/x1/XBrowser_User_Guide.pdf

## 基本:
+ 1セクタ = 256バイト
+ 1クラスタ =  16セクタ = 1トラック
+ ファイルシステムはクラスタ単位で管理する
+ 特記しない限りはリトルエンディアン
+ トラックとセクタの関係は以下の通り

|  トラック  |    セクタ     |
| ---------- | ------------- |
| トラック0  | 1～16セクタ   |
| トラック1  | 1～16セクタ   |
| …         | …            |
| トラック79 | 1～16クラスタ |


## ブートセクタ
+ 位置:トラック0 / 1セクタ目
+ 32バイト

|      名前      | 位置 | サイズ |                     詳細                      |
| -------------- | ---- | ------ | --------------------------------------------- |
| ブートフラグ   | $00  | 1      | 0x01=起動可能                                 |
| ラベル         | $01  | 13     | IPLにより表示                                 |
| 拡張子         | $0E  | 4      | 'Sys' + 0x20                                  |
| サイズ         | $12  | 2      | プログラムサイズ                              |
| ロードアドレス | $14  | 2      |                                               |
| 実行アドレス   | $16  | 2      |                                               |
| 日付           | $18  | 6      | 日付フォーマット                              |
| 開始セクタ     | $1E  | 2      | セクタ数であることに注意連続であることが必要 |

## アロケーションテーブル:
+ 位置: トラック0 / 15セクタ, 16セクタ
+ 0クラスタ目から順番に最大80クラスタ分ある。

内容は次の通り
+ 0x00は未使用（空き）
+ 0x80-0x8fはファイル終端を示す  
下位4ビットの0x00-0x0Fはクラスタ中で使用された最後のセクタ
+ 他の値は次のクラスタの位置を示す

[note] 最初の2クラスタ分はファイルシステムで利用するために予約されている。  
その為、通常は0x01,0x8Fと書かれている。

## ディレクトリエントリ:
+ 位置:トラック1/1セクタ目
+ 17セクタ目に位置する
+ 32バイト

|       名前       | 位置 | サイズ |    詳細    |
| ---------------- | ---- | ------ | ---------- |
| ファイルモード   | $0   | 1      |            |
| ファイル名       | $1   | 13     |            |
| 拡張子           | $e   | 4      | 0x20で終了 |
| サイズ           | $12  | 2      |            |
| 読み出しアドレス | $14  | 2      |            |
| 実行アドレス     | $16  | 2      |            |
| 日付             | $18  | 6      |            |
| 開始クラスタ     | $1e  | 2      |            |


## ファイルモード:
|  値  |         機能         |
| ---- | -------------------- |
| 0x00 | 削除済み(上書き可能) |
| 0xFF | エントリの終了       |


### 値の詳細

| ビット |     機能     |
| ------ | ------------ |
| 7      | ディレクトリ |
| 6      | 読み出しのみ |
| 5      | ベリファイ   |
| 4      | 隠しファイル |
| 3      | アスキー     |
| 2      | アスキー     |
| 1      | BASIC        |
| 0      | バイナリ     |

## ファイル名:
+ ファイル名と拡張子は0x20で後ろが埋まっている。
+ 例として、拡張子'TXT'の場合は、  
``` 
'T','X','T',0x20
```
となる

+ 大文字、小文字が使用可能。
+ ケースセンシティブかどうかは不明。

## 日付:
+ 6バイト
+ 月+曜日以外はBCD表記

|  名前   | サイズ |  詳細  |
| ------- | ------ | ------ |
| 年      | 1      |        |
| 月+曜日 | 1      | [1]    |
| 日      | 1      |        |
| 時      | 1      | 24時間 |
| 分      | 1      |        |
| 秒      | 1      |        |

[1] 上位4ビットは1～12月、下位4ビットは曜日(0から6)

年は下二桁、80未満の場合は2000を足すとよいかもしれない。  
BCD = 4ビットに一桁が割り当てられている。  
例 : 分は8分であれば0x08、45分であれば0x45。
